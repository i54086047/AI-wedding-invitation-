<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>建立你的電子喜帖</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0b0f;
      --card: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --dim: rgba(255,255,255,0.70);
      --accent:#c9a27d;
      --accent-dark:#a07c56;
      --radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans TC", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 15% 10%, rgba(201,162,125,0.12), transparent 45%),
                  radial-gradient(circle at 80% 0%, rgba(255,255,255,0.06), transparent 40%),
                  var(--bg);
      color: var(--text);
    }
    .wrap{
      width: min(980px, 100%);
      margin: 0 auto;
      padding: 28px 16px 64px;
    }
    .header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom: 18px;
    }
    h1{
      font-size: 22px;
      margin:0;
      letter-spacing: .02em;
    }
    .sub{
      margin-top:8px;
      color: var(--dim);
      font-size: 13px;
      line-height: 1.6;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      margin-top: 14px;
      backdrop-filter: blur(10px);
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
    }
    label{
      display:block;
      font-size: 12px;
      color: rgba(255,255,255,0.86);
      margin: 0 0 6px;
    }
    input, textarea, select{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      outline: none;
    }
    textarea{ min-height: 86px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,0.45); }

    .hint{
      margin-top: 6px;
      color: rgba(255,255,255,0.55);
      font-size: 12px;
      line-height: 1.5;
    }
    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .section-title h2{
      margin:0;
      font-size: 15px;
      letter-spacing:.02em;
    }
    .tag{
      font-size: 12px;
      color: rgba(255,255,255,0.75);
      border: 1px solid rgba(255,255,255,0.14);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
    }

    .uploader{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 760px){
      .uploader{ grid-template-columns: 1fr; }
    }
    .upload-box{
      border: 1px dashed rgba(255,255,255,0.22);
      border-radius: 14px;
      padding: 12px;
      background: rgba(0,0,0,0.18);
    }
    .upload-box .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .upload-box .name{
      font-weight: 600;
      font-size: 13px;
    }
    .upload-box small{
      display:block;
      margin-top: 6px;
      color: rgba(255,255,255,0.55);
      line-height: 1.5;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin-top: 16px;
      align-items:center;
    }
    .btn{
      border:none;
      cursor:pointer;
      border-radius: 999px;
      padding: 11px 16px;
      font-size: 13px;
      color: #fff;
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
      user-select:none;
      transition: transform .18s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
      white-space: nowrap;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .btn-primary{
      background: var(--accent);
      box-shadow: var(--shadow);
    }
    .btn-primary:hover{ background: var(--accent-dark); transform: translateY(-1px); }
    .btn-ghost{
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .btn-ghost:hover{ border-color: rgba(255,255,255,0.35); transform: translateY(-1px); }

    .status{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.75);
    }
    .error{ color: #ffb4b4; }
    .ok{ color: #bfffd6; }

    .divider{
      height:1px;
      background: rgba(255,255,255,0.10);
      margin: 14px 0;
    }

    /* ===== AI Wizard (one question per page) ===== */
    .wizard{
      margin-top:14px;
      overflow:hidden;
    }
    .wizard-top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .wizard-progress{
      display:flex;
      align-items:center;
      gap:10px;
      color: rgba(255,255,255,0.75);
      font-size:12px;
    }
    .dots{
      display:flex;
      gap:6px;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      border:1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.08);
    }
    .dot.active{ background: rgba(201,162,125,0.85); border-color: rgba(201,162,125,0.85); }
    .wizard-stage{
      min-height: 320px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 6px;
    }
    .wizard-panel{
      width: min(720px, 100%);
      text-align:center;
      opacity:1;
      transform: translateY(0);
      transition: opacity .28s ease, transform .28s ease;
    }
    .wizard-panel.fade-out{ opacity:0; transform: translateY(10px); }
    .wizard-q{
      font-size: 18px;
      line-height: 1.5;
      margin: 0 0 14px;
      letter-spacing: .01em;
    }
    .wizard-a{
      width:100%;
      min-height: 140px;
      text-align:left;
      font-size: 14px;
      line-height: 1.7;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.28);
    }
    .wizard-actions{
      margin-top: 14px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .wizard-small{
      margin-top:10px;
      color: rgba(255,255,255,0.60);
      font-size:12px;
      line-height:1.5;
    }

    /* ===== Generating overlay ===== */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .overlay.show{ display:flex; }
    .overlay-card{
      width: min(760px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(20,20,26,0.55);
      box-shadow: var(--shadow);
      padding: 22px 18px;
    }
    .gen-title{
      margin:0 0 8px;
      font-size: 16px;
      letter-spacing:.02em;
    }
    .gen-line{
      margin: 14px 0 0;
      color: rgba(255,255,255,0.85);
      font-size: 14px;
      line-height: 1.7;
      min-height: 52px;
      opacity:1;
      transform: translateY(0);
      transition: opacity .25s ease, transform .25s ease;
    }
    .gen-line.fade{ opacity:0; transform: translateY(8px); }
    .spinner{
      width: 18px; height:18px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.18);
      border-top-color: rgba(201,162,125,0.9);
      animation: spin .9s linear infinite;
      display:inline-block;
      vertical-align: -3px;
      margin-right: 8px;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    /* utility */
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1 id="t_title">建立你的電子喜帖</h1>
        <div class="sub" id="t_sub">
          填最必要的資訊 + 上傳 4 張背景照片，即可生成你那個「四頁翻頁」模板。<br/>
          建議照片用橫式、解析度至少 1600px 寬（手機原圖通常 OK）。
        </div>
      </div>
      <span class="tag" id="t_tag">MVP 表單介面</span>
    </div>

    <!-- AI Wizard -->
    <div class="card wizard" id="aiWizard">
      <div class="section-title">
        <h2 id="t_ai_h2">AI 問答（一次一題）</h2>
        <span class="tag" id="t_ai_tag">可選</span>
      </div>

      <div class="wizard-top">
        <div class="wizard-progress">
          <span id="t_lang_label">語言</span>
          <select id="langSelect" style="width:auto; min-width: 160px;">
            <option value="zh">繁體中文</option>
            <option value="en">English</option>
            <option value="ko">한국어</option>
            <option value="vi">Tiếng Việt</option>
          </select>
        </div>

        <div class="wizard-progress">
          <span id="stepText">1 / 3</span>
          <div class="dots" aria-hidden="true">
            <span class="dot active" id="dot1"></span>
            <span class="dot" id="dot2"></span>
            <span class="dot" id="dot3"></span>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="wizard-stage">
        <div class="wizard-panel" id="wizardPanel">
          <p class="wizard-q" id="wizardQ">Q1</p>
          <textarea class="wizard-a" id="wizardA" placeholder=""></textarea>

          <div class="wizard-actions">
            <button class="btn btn-ghost" type="button" id="btnPrev">上一步</button>
            <button class="btn btn-primary" type="button" id="btnNext">下一步</button>
            <button class="btn btn-ghost" type="button" id="btnReset">清空</button>
          </div>

          <div class="wizard-small" id="wizardHint">
            回答完三題後按「生成」會自動填入下方表單，你仍可手動修改。
          </div>
        </div>
      </div>

      <div class="actions" style="justify-content:center;">
        <button class="btn btn-primary" type="button" id="btnGenerateAI">生成文案並自動填入表單</button>
      </div>

      <div id="aiStatus" class="status"></div>
    </div>

    <!-- Main Form -->
    <form id="inviteForm" class="card" enctype="multipart/form-data">
      <div class="section-title">
        <h2>基本資訊</h2>
        <span class="tag">必填</span>
      </div>

      <div class="grid">
        <div>
          <label for="couple_title">新人稱呼（標題）</label>
          <input id="couple_title" name="couple_title" placeholder="例：Chun-Wei & Yerim" required />
          <div class="hint">會出現在封面大標題。</div>
        </div>

        <div>
          <label for="page_title">瀏覽器標題（title）</label>
          <input id="page_title" name="page_title" placeholder="例：Chun-Wei & Yerim｜婚禮喜帖" required />
        </div>

        <div>
          <label for="wedding_date_text">日期（顯示文字）</label>
          <input id="wedding_date_text" name="wedding_date_text" placeholder="例：2027 / 01 / 16 (六)" required />
        </div>

        <div>
          <label for="wedding_time_text">時間（顯示文字）</label>
          <input id="wedding_time_text" name="wedding_time_text" placeholder="例：入場 18:00，儀式 18:30" required />
        </div>

        <div>
          <label for="venue_name">地點名稱</label>
          <input id="venue_name" name="venue_name" placeholder="例：首爾君悅酒店" required />
        </div>

        <div>
          <label for="venue_address">地址</label>
          <input id="venue_address" name="venue_address" placeholder="例：韓國 首爾特別市 ..." required />
        </div>

        <div>
          <label for="map_url">Google Map 連結</label>
          <input id="map_url" name="map_url" placeholder="貼 Google Maps 分享連結（或 search/?api=1...）" required />
        </div>

        <div>
          <label for="rsvp_url">RSVP 表單連結</label>
          <input id="rsvp_url" name="rsvp_url" placeholder="Google 表單連結 / 其他報名表" required />
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>文案</h2>
        <span class="tag">可先用預設值</span>
      </div>

      <div class="grid">
        <div>
          <label for="cover_subtitle">封面短句</label>
          <textarea id="cover_subtitle" name="cover_subtitle" placeholder="例：誠摯邀請您，一起見證我們步入新的旅程。" required></textarea>
        </div>

        <div>
          <label for="story_subtitle">故事頁副標</label>
          <textarea id="story_subtitle" name="story_subtitle" placeholder="例：跨越台南與首爾的日常..." required></textarea>
        </div>

        <div>
          <label for="story_p1">故事段落 1</label>
          <textarea id="story_p1" name="story_p1" required></textarea>
        </div>

        <div>
          <label for="story_p2">故事段落 2</label>
          <textarea id="story_p2" name="story_p2" required></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>當天流程（3 條）</h2>
        <span class="tag">必填</span>
      </div>

      <div class="grid">
        <div>
          <label>流程 1 時間</label>
          <input name="tl1_time" placeholder="例：18:00" required />
        </div>
        <div>
          <label>流程 1 內容</label>
          <input name="tl1_text" placeholder="例：賓客入場、簡單合照" required />
        </div>

        <div>
          <label>流程 2 時間</label>
          <input name="tl2_time" placeholder="例：18:30" required />
        </div>
        <div>
          <label>流程 2 內容</label>
          <input name="tl2_text" placeholder="例：證婚儀式開始" required />
        </div>

        <div>
          <label>流程 3 時間</label>
          <input name="tl3_time" placeholder="例：19:30" required />
        </div>
        <div>
          <label>流程 3 內容</label>
          <input name="tl3_text" placeholder="例：晚宴、致詞與互動時間" required />
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>照片上傳（4 張）</h2>
        <span class="tag">必填</span>
      </div>

      <div class="uploader">
        <div class="upload-box wide">
          <div class="top">
            <div class="name">上傳 4 張照片（依序套用）</div>
          </div>

          <input type="file" name="photos" accept="image/*" multiple required />

          <small>
            請一次選取 <b>4 張照片</b>，將依序套用為：<br/>
            ① 封面（Cover） → ② 故事（Story） → ③ 資訊（Details） → ④ RSVP
            <br/>
            建議橫式、主體置中。
          </small>
        </div>
      </div>

      <!-- 固定文案（保留你的模板） -->
      <input type="hidden" name="brand_title" value="C & Y Wedding" />
      <input type="hidden" name="brand_sub" value="滑鼠滾輪一次切換一頁" />
      <input type="hidden" name="rsvp_button_text" value="我要出席 RSVP" />

      <input type="hidden" name="btn_view_details" value="查看婚禮資訊" />
      <input type="hidden" name="btn_our_story" value="我們的故事" />
      <input type="hidden" name="btn_next_details" value="下一頁：婚禮資訊" />
      <input type="hidden" name="btn_back_cover" value="回到封面" />
      <input type="hidden" name="story_title" value="我們的故事" />

      <input type="hidden" name="details_title" value="Wedding Day" />
      <input type="hidden" name="details_subtitle" value="當天流程與場地資訊" />
      <input type="hidden" name="btn_open_map" value="在 Google 地圖中開啟" />
      <input type="hidden" name="btn_next_rsvp" value="下一頁：RSVP" />
      <input type="hidden" name="details_note" value="＊若想內嵌 Google Map，我也可以幫你加 iframe。" />

      <input type="hidden" name="rsvp_title" value="RSVP 出席回覆" />
      <input type="hidden" name="rsvp_subtitle" value="為了讓我們能好好準備座位與餐點，請花一點時間填寫出席回覆。" />
      <input type="hidden" name="rsvp_step1" value="1) 點擊下方按鈕前往回覆表單（建議使用 Google 表單）。" />
      <input type="hidden" name="rsvp_step2" value="2) 填寫您的姓名、人數與飲食需求。" />
      <input type="hidden" name="rsvp_step3" value="3) 送出後，我們會在婚禮前再與您確認。" />
      <input type="hidden" name="btn_open_rsvp" value="前往 RSVP 表單" />
      <input type="hidden" name="rsvp_hint" value="＊若無法使用表單，也可以直接回覆這封電子喜帖的寄件人。" />

      <div class="actions">
        <button class="btn btn-primary" type="submit">生成喜帖</button>
        <button class="btn btn-ghost" type="button" id="fillDemo">填入範例</button>
      </div>

      <div id="status" class="status"></div>
    </form>
  </div>

  <!-- Generating overlay -->
  <div class="overlay" id="genOverlay" aria-hidden="true">
    <div class="overlay-card">
      <h3 class="gen-title" id="genTitle"><span class="spinner"></span>正在生成中…</h3>
      <div class="sub" id="genSub">我們會先整理你的三題回答，接著把文案填入表單。</div>
      <div class="gen-line" id="genLine"></div>
      <div class="status" id="genStatus"></div>
      <div class="actions" style="justify-content:flex-end; margin-top:16px;">
        <button class="btn btn-ghost" type="button" id="genCloseBtn" disabled>請稍候…</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       i18n (zh/en/ko/vi)
    ========================== */
    const I18N = {
      zh: {
        pageTitle: "建立你的電子喜帖",
        sub: "填最必要的資訊 + 上傳 4 張背景照片，即可生成你那個「四頁翻頁」模板。<br/>建議照片用橫式、解析度至少 1600px 寬（手機原圖通常 OK）。",
        tag: "MVP 表單介面",
        aiH2: "AI 問答（一次一題）",
        aiTag: "可選",
        langLabel: "語言",
        hint: "回答完三題後按「生成」會自動填入下方表單，你仍可手動修改。",
        prev: "上一步",
        next: "下一步",
        reset: "清空",
        generate: "生成文案並自動填入表單",
        needAnswer: "請先回答這題再繼續。",
        okFilled: "✅ 已填入表單，你可以再微調。",
        fail: "❌ ",
        overlayTitle: "正在生成中…",
        overlaySub: "我們會先整理你的三題回答，接著把文案填入表單。",
        overlayWait: "請稍候…",
        overlayDone: "完成，回到表單",
        overlayFail: "生成失敗：",
        q: [
          {
            title: "Q1｜請簡單介紹你們：是哪兩位新人要結婚？也可以提一下你們怎麼認識的。",
            placeholder: "例：我們在某個平凡的下午認識，後來把日常慢慢走成了未來…"
          },
          {
            title: "Q2｜你最喜歡對方的一件小事（越具體越好）。",
            placeholder: "例：他總會在我忙到忘記吃飯時，默默把晚餐放到桌上。"
          },
          {
            title: "Q3｜婚禮想怎麼進行？最重要的是時間與地點，也可以說你希望賓客感受到什麼。",
            placeholder: "例：我們希望這天很溫暖、很輕鬆，像一場和重要的人相聚的晚餐。"
          }
        ],
        genLines: [
          "把你們的日常，寫成一封剛剛好的邀請。",
          "不張揚，但很確定：這一天想和你分享。",
          "故事不必很長，因為你們會一直走下去。",
          "把重要的人放進同一個畫面，就成了婚禮。",
          "謝謝你願意來，替我們的這一頁簽名。"
        ]
      },
      en: {
        pageTitle: "Create Your Wedding E-Invitation",
        sub: "Fill the essentials + upload 4 background photos to generate the 4-page scrolling template.<br/>Landscape photos recommended (≥1600px width).",
        tag: "MVP Form",
        aiH2: "AI Q&A (one question at a time)",
        aiTag: "Optional",
        langLabel: "Language",
        hint: "After 3 answers, click Generate to auto-fill the form below. You can still edit manually.",
        prev: "Back",
        next: "Next",
        reset: "Clear",
        generate: "Generate copy & auto-fill the form",
        needAnswer: "Please answer this question to continue.",
        okFilled: "✅ Filled. You can fine-tune the text.",
        fail: "❌ ",
        overlayTitle: "Generating…",
        overlaySub: "We’ll summarize your answers, then fill the form copy.",
        overlayWait: "Please wait…",
        overlayDone: "Done — back to form",
        overlayFail: "Generation failed: ",
        q: [
          {
            title: "Q1｜Who are the two people getting married? (You can also share how you met.)",
            placeholder: "e.g., We met on an ordinary day, and somehow that became our forever…"
          },
          {
            title: "Q2｜One small thing you love about them (be specific).",
            placeholder: "e.g., They always remember my favorite drink—even on busy days."
          },
          {
            title: "Q3｜How will the wedding day go? Time & place matter most—what do you want guests to feel?",
            placeholder: "e.g., Warm, relaxed, like a dinner with the people we love most."
          }
        ],
        genLines: [
          "Turning your everyday moments into a quiet invitation.",
          "Not loud—just certain: we want to share this day with you.",
          "The story doesn’t need to be long, because you’ll keep writing it.",
          "Put the right people in the same frame—that’s a wedding.",
          "Thanks for being part of this page in our story."
        ]
      },
      ko: {
        pageTitle: "모바일 청첩장 만들기",
        sub: "필수 정보 입력 + 배경 사진 4장을 업로드하면 4페이지 스크롤 템플릿이 생성됩니다.<br/>가로 사진(가로 1600px 이상) 추천.",
        tag: "MVP 폼",
        aiH2: "AI 문답(한 번에 한 질문)",
        aiTag: "선택",
        langLabel: "언어",
        hint: "3문항 답변 후 ‘생성’을 누르면 아래 폼에 자동으로 채워집니다. 이후 수정 가능해요.",
        prev: "이전",
        next: "다음",
        reset: "초기화",
        generate: "문구 생성 후 폼에 자동 입력",
        needAnswer: "계속하려면 답변을 입력해 주세요.",
        okFilled: "✅ 폼에 입력 완료. 조금 더 다듬어도 좋아요.",
        fail: "❌ ",
        overlayTitle: "생성 중…",
        overlaySub: "3개의 답변을 정리한 뒤, 폼 문구를 채워드립니다.",
        overlayWait: "잠시만요…",
        overlayDone: "완료 — 폼으로 돌아가기",
        overlayFail: "생성 실패: ",
        q: [
          {
            title: "Q1｜결혼하는 두 분은 누구인가요? 어떻게 만나게 되었는지도 좋아요.",
            placeholder: "예: 평범한 하루에 만났고, 그게 우리의 미래가 되었어요…"
          },
          {
            title: "Q2｜상대의 ‘작은 습관/행동’ 중 가장 좋아하는 건?",
            placeholder: "예: 바쁜 날에도 제가 좋아하는 걸 꼭 챙겨줘요."
          },
          {
            title: "Q3｜결혼식은 어떻게 진행되나요? 시간/장소가 가장 중요해요. 하객에게 전하고 싶은 분위기도!",
            placeholder: "예: 따뜻하고 편안한, 소중한 사람들과의 저녁식사 같은 날."
          }
        ],
        genLines: [
          "우리의 일상을, 조용한 초대장으로 바꿔볼게요.",
          "화려하진 않아도 확실해요—이날을 함께하고 싶어요.",
          "이야기는 길 필요 없어요. 앞으로도 계속 써갈 테니까요.",
          "중요한 사람들을 한 장면에 담으면, 그게 결혼식이죠.",
          "와줘서 고마워요. 우리의 한 페이지가 되어주세요."
        ]
      },
      vi: {
        pageTitle: "Tạo Thiệp Cưới Điện Tử",
        sub: "Điền thông tin cần thiết + tải lên 4 ảnh nền để tạo mẫu 4 trang cuộn.<br/>Khuyến nghị ảnh ngang (rộng ≥1600px).",
        tag: "MVP Form",
        aiH2: "Hỏi đáp AI (mỗi lần 1 câu)",
        aiTag: "Tuỳ chọn",
        langLabel: "Ngôn ngữ",
        hint: "Trả lời 3 câu rồi bấm Tạo để tự điền nội dung vào form bên dưới. Bạn vẫn có thể chỉnh sửa.",
        prev: "Quay lại",
        next: "Tiếp theo",
        reset: "Xoá",
        generate: "Tạo nội dung & tự điền form",
        needAnswer: "Vui lòng trả lời câu này để tiếp tục.",
        okFilled: "✅ Đã điền vào form. Bạn có thể chỉnh lại cho hợp ý.",
        fail: "❌ ",
        overlayTitle: "Đang tạo…",
        overlaySub: "Chúng tôi sẽ tổng hợp 3 câu trả lời và điền nội dung vào form.",
        overlayWait: "Vui lòng đợi…",
        overlayDone: "Xong — quay lại form",
        overlayFail: "Tạo thất bại: ",
        q: [
          {
            title: "Q1｜Hai bạn là ai? (Có thể kể ngắn về cách gặp nhau.)",
            placeholder: "VD: Chúng mình gặp nhau trong một ngày rất bình thường, rồi thành tương lai của nhau…"
          },
          {
            title: "Q2｜Một điều nhỏ bạn thích ở đối phương (cụ thể càng tốt).",
            placeholder: "VD: Dù bận đến đâu, họ vẫn nhớ mình thích ăn gì."
          },
          {
            title: "Q3｜Ngày cưới sẽ diễn ra thế nào? Thời gian/địa điểm quan trọng nhất—bạn muốn khách cảm nhận điều gì?",
            placeholder: "VD: Ấm áp, nhẹ nhàng, như một bữa tối với những người quan trọng."
          }
        ],
        genLines: [
          "Biến những điều thường ngày thành một lời mời thật vừa đủ.",
          "Không phô trương, nhưng rất chắc chắn: muốn chia sẻ ngày này với bạn.",
          "Câu chuyện không cần dài, vì hai bạn sẽ còn viết tiếp.",
          "Đặt đúng người vào cùng một khung hình—đó là đám cưới.",
          "Cảm ơn vì bạn đến và ký tên vào trang này của chúng mình."
        ]
      }
    };

    let currentLang = "zh";
    const answers = ["", "", ""]; // Q1..Q3
    let step = 0; // 0..2
    const FADE_MS = 220;

    const els = {
      t_title: document.getElementById("t_title"),
      t_sub: document.getElementById("t_sub"),
      t_tag: document.getElementById("t_tag"),
      t_ai_h2: document.getElementById("t_ai_h2"),
      t_ai_tag: document.getElementById("t_ai_tag"),
      t_lang_label: document.getElementById("t_lang_label"),

      langSelect: document.getElementById("langSelect"),
      stepText: document.getElementById("stepText"),
      dot1: document.getElementById("dot1"),
      dot2: document.getElementById("dot2"),
      dot3: document.getElementById("dot3"),

      panel: document.getElementById("wizardPanel"),
      q: document.getElementById("wizardQ"),
      a: document.getElementById("wizardA"),
      hint: document.getElementById("wizardHint"),
      btnPrev: document.getElementById("btnPrev"),
      btnNext: document.getElementById("btnNext"),
      btnReset: document.getElementById("btnReset"),
      btnGenerateAI: document.getElementById("btnGenerateAI"),
      aiStatus: document.getElementById("aiStatus"),

      genOverlay: document.getElementById("genOverlay"),
      genTitle: document.getElementById("genTitle"),
      genSub: document.getElementById("genSub"),
      genLine: document.getElementById("genLine"),
      genStatus: document.getElementById("genStatus"),
      genCloseBtn: document.getElementById("genCloseBtn"),
    };

    function applyLang(lang){
      currentLang = lang;
      const t = I18N[lang];

      // top texts
      document.title = t.pageTitle;
      els.t_title.textContent = t.pageTitle;
      els.t_sub.innerHTML = t.sub;
      els.t_tag.textContent = t.tag;

      // wizard labels
      els.t_ai_h2.textContent = t.aiH2;
      els.t_ai_tag.textContent = t.aiTag;
      els.t_lang_label.textContent = t.langLabel;

      els.btnPrev.textContent = t.prev;
      els.btnNext.textContent = (step === 2) ? t.next : t.next;
      els.btnReset.textContent = t.reset;
      els.btnGenerateAI.textContent = t.generate;
      els.hint.textContent = t.hint;

      // overlay
      els.genTitle.innerHTML = `<span class="spinner"></span>${t.overlayTitle}`;
      els.genSub.textContent = t.overlaySub;
      els.genCloseBtn.textContent = t.overlayWait;

      // re-render step
      renderStep(false);
    }

    function renderDots(){
      [els.dot1, els.dot2, els.dot3].forEach((d, i) => {
        d.classList.toggle("active", i === step);
      });
      els.stepText.textContent = `${step + 1} / 3`;
    }

    function renderStep(withFade=true){
      const t = I18N[currentLang];

      const doRender = () => {
        renderDots();
        els.q.textContent = t.q[step].title;
        els.a.placeholder = t.q[step].placeholder;
        els.a.value = answers[step] || "";

        els.btnPrev.disabled = (step === 0);
        els.btnNext.disabled = false;

        // focus a bit later for mobile keyboard stability
        setTimeout(() => els.a.focus(), 30);
      };

      if(!withFade){
        doRender();
        return;
      }

      // fade out -> swap -> fade in
      els.panel.classList.add("fade-out");
      setTimeout(() => {
        doRender();
        els.panel.classList.remove("fade-out");
      }, FADE_MS);
    }

    function saveCurrentAnswer(){
      answers[step] = (els.a.value || "").trim();
    }

    function requireAnswerOrWarn(){
      const t = I18N[currentLang];
      saveCurrentAnswer();
      if(!answers[step]){
        els.aiStatus.className = "status error";
        els.aiStatus.textContent = t.needAnswer;
        els.a.focus();
        return false;
      }
      els.aiStatus.textContent = "";
      els.aiStatus.className = "status";
      return true;
    }

    els.langSelect.addEventListener("change", () => applyLang(els.langSelect.value));

    els.btnPrev.addEventListener("click", () => {
      saveCurrentAnswer();
      if(step > 0){
        step -= 1;
        renderStep(true);
      }
    });

    els.btnNext.addEventListener("click", () => {
      if(!requireAnswerOrWarn()) return;
      if(step < 2){
        step += 1;
        renderStep(true);
      }else{
        // last step, just stay (generate button below)
        els.aiStatus.className = "status";
      }
    });

    els.btnReset.addEventListener("click", () => {
      answers[0] = answers[1] = answers[2] = "";
      els.aiStatus.textContent = "";
      els.aiStatus.className = "status";
      renderStep(false);
    });

    // allow Enter+Ctrl/Meta to next
    els.a.addEventListener("keydown", (e) => {
      if((e.ctrlKey || e.metaKey) && e.key === "Enter"){
        els.btnNext.click();
      }
    });

    /* =========================
       Generating overlay lines
    ========================== */
    let lineTimer = null;
    function startLineRotation(){
      const t = I18N[currentLang];
      const pool = [...t.genLines];
      // shuffle
      for(let i=pool.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      let idx = 0;

      const showLine = () => {
        els.genLine.classList.add("fade");
        setTimeout(() => {
          els.genLine.textContent = pool[idx % pool.length];
          els.genLine.classList.remove("fade");
          idx += 1;
        }, 180);
      };

      showLine();
      lineTimer = setInterval(showLine, 1300);
    }

    function stopLineRotation(){
      if(lineTimer) clearInterval(lineTimer);
      lineTimer = null;
    }

    function openOverlay(){
      els.genOverlay.classList.add("show");
      els.genOverlay.setAttribute("aria-hidden", "false");
      els.genStatus.textContent = "";
      els.genStatus.className = "status";
      els.genCloseBtn.disabled = true;
      els.genCloseBtn.textContent = I18N[currentLang].overlayWait;
      startLineRotation();
    }

    function closeOverlay(){
      stopLineRotation();
      els.genOverlay.classList.remove("show");
      els.genOverlay.setAttribute("aria-hidden", "true");
    }

    // only allow close after done/fail
    els.genCloseBtn.addEventListener("click", () => {
      if(els.genCloseBtn.disabled) return;
      closeOverlay();
      // scroll to form
      document.getElementById("inviteForm").scrollIntoView({ behavior:"smooth", block:"start" });
    });

    /* =========================
       Call backend /api/ai_prefill
       (expects: { ok: true, data: {...} })
    ========================== */
    els.btnGenerateAI.addEventListener("click", async () => {
      const t = I18N[currentLang];

      // ensure all answers exist
      saveCurrentAnswer();
      for(let i=0;i<3;i++){
        if(!answers[i]){
          step = i;
          renderStep(true);
          els.aiStatus.className = "status error";
          els.aiStatus.textContent = t.needAnswer;
          return;
        }
      }

      openOverlay();

      const payload = {
        lang: currentLang, // ✅ optional: you can read this in backend if you want
        answers: [
          { q: "Q1", a: answers[0] },
          { q: "Q2", a: answers[1] },
          { q: "Q3", a: answers[2] },
        ]
      };

      try{
        const res = await fetch("/api/ai_prefill", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        // safer parse
        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch(e){}

        if(!res.ok){
          throw new Error(`${res.status} ${text.slice(0, 200)}`);
        }
        if(!data || !data.ok){
          throw new Error((data && data.error) ? data.error : "AI response not ok");
        }

        const fill = data.data || {};
        const form = document.getElementById("inviteForm");

        // fill copy
        if (fill.cover_subtitle) form.cover_subtitle.value = fill.cover_subtitle;
        if (fill.story_subtitle) form.story_subtitle.value = fill.story_subtitle;
        if (fill.story_p1) form.story_p1.value = fill.story_p1;
        if (fill.story_p2) form.story_p2.value = fill.story_p2;

        // optionally fill basics if backend sends them
        if (fill.page_title) form.page_title.value = fill.page_title;
        if (fill.couple_title) form.couple_title.value = fill.couple_title;
        if (fill.wedding_date_text) form.wedding_date_text.value = fill.wedding_date_text;
        if (fill.wedding_time_text) form.wedding_time_text.value = fill.wedding_time_text;
        if (fill.venue_name) form.venue_name.value = fill.venue_name;
        if (fill.venue_address) form.venue_address.value = fill.venue_address;
        if (fill.map_url) form.map_url.value = fill.map_url;
        if (fill.rsvp_url) form.rsvp_url.value = fill.rsvp_url;

        // timeline
        if (fill.tl1_time) form.tl1_time.value = fill.tl1_time;
        if (fill.tl1_text) form.tl1_text.value = fill.tl1_text;
        if (fill.tl2_time) form.tl2_time.value = fill.tl2_time;
        if (fill.tl2_text) form.tl2_text.value = fill.tl2_text;
        if (fill.tl3_time) form.tl3_time.value = fill.tl3_time;
        if (fill.tl3_text) form.tl3_text.value = fill.tl3_text;

        // statuses
        els.aiStatus.className = "status ok";
        els.aiStatus.textContent = t.okFilled;

        els.genStatus.className = "status ok";
        els.genStatus.textContent = t.okFilled;

        els.genCloseBtn.disabled = false;
        els.genCloseBtn.textContent = t.overlayDone;
      }catch(err){
        els.aiStatus.className = "status error";
        els.aiStatus.textContent = t.fail + err.message;

        els.genStatus.className = "status error";
        els.genStatus.textContent = t.overlayFail + err.message;

        els.genCloseBtn.disabled = false;
        els.genCloseBtn.textContent = "Close";
      }
    });

    /* =========================
       Existing form submit (/api/create)
    ========================== */
    const form = document.getElementById('inviteForm');
    const statusEl = document.getElementById('status');
    const fillDemoBtn = document.getElementById('fillDemo');

    fillDemoBtn.addEventListener('click', () => {
      form.page_title.value = 'Chun-Wei & Yerim｜婚禮喜帖';
      form.couple_title.value = 'Chun-Wei & Yerim';
      form.wedding_date_text.value = '2027 / 01 / 16 (六)';
      form.wedding_time_text.value = '入場 18:00，儀式 18:30';
      form.venue_name.value = '首爾君悅酒店';
      form.venue_address.value = '韓國 首爾特別市 龍산구 소월로 322 (한남동) 04347';
      form.map_url.value = 'https://www.google.com/maps/search/?api=1&query=Grand%20Hyatt%20Seoul';
      form.rsvp_url.value = 'https://docs.google.com/forms';

      form.cover_subtitle.value = '誠摯邀請您，一起見證我們步入新的旅程。';
      form.story_subtitle.value = '跨越台南與首爾的日常，慢慢疊起來，就變成了今天的我們。';
      form.story_p1.value = '從一通訊息、一張機票開始，我們學會在不同的城市裡替彼此保留一個位置，期待著下一次重逢。';
      form.story_p2.value = '現在，我們想邀請你／妳，一起來到這一天，見證我們把這段旅程，變成同一個「家」。';

      form.tl1_time.value = '18:00';
      form.tl1_text.value = '賓客入場、簡單合照';
      form.tl2_time.value = '18:30';
      form.tl2_text.value = '證婚儀式開始';
      form.tl3_time.value = '19:30';
      form.tl3_text.value = '晚宴、致詞與互動時間';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = '正在上傳與生成中…';
      statusEl.className = 'status';

      const fd = new FormData(form);

      try {
        const res = await fetch('/api/create', { method: 'POST', body: fd });

        // read text first (avoid JSON crash)
        const text = await res.text();
        console.log('status:', res.status);
        console.log('response text:', text);

        if (!res.ok) {
          throw new Error(`伺服器回應失敗：${res.status}\n${text.slice(0, 200)}`);
        }

        const data = JSON.parse(text);

        statusEl.innerHTML = `✅ 已生成：<a href="${data.url}" target="_blank" style="color:inherit;text-decoration:underline">${data.url}</a>`;
        statusEl.classList.add('ok');
      } catch (err) {
        statusEl.textContent = '❌ 生成失敗：' + err.message;
        statusEl.classList.add('error');
      }
    });

    // photo validation: exactly 4
    const photoInput = document.querySelector('input[name="photos"]');
    photoInput.addEventListener('change', () => {
      if (photoInput.files.length !== 4) {
        alert("請一次選取「剛好 4 張」照片，會依順序套用。");
        photoInput.value = "";
      }
    });

    // init
    applyLang("zh");
  </script>
</body>
</html>
